---
title: "BT12"
author: "Thịnh"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
```

## Bài tập 12
(Khoa học môi trường). Dữ liệu Bangladesh.csv chứa thông tin về hàm lượng các
chất hóa học gây độc trong nước giếng ở Bangladesh. Các chất được đo đạc bao gồm: Arsenic,
Chlorine và Cobalt. Có tất cả 271 giếng đã được lấy mẫu nước.

### a) 
Thực hiện các bước phân tích khám phá dữ liệu hàm lượng chlorine trong nước giếng, và mô
tả các đặc điểm nổi bật. Chú ý, dữ liệu Chlorine có các giá trị khuyết (NA) cần phải xử lý loại bỏ các quan sát này trước.

```{r}
# Quan sát dữ liệu 
data_enviroment <- read.csv(file = "lab02/Code/data/Bangladesh.csv")
summary(data_enviroment)
str(data_enviroment)
```
```{r}
# Lọc và mô tả dữ liệu
data_enviroment |>
  filter(!is.na(Chlorine)) |>  
  summarize(across(.cols = Chlorine, .fns = list(
    mean = ~mean(., na.rm = TRUE),
    median = ~median(., na.rm = TRUE),
    sd = ~sd(., na.rm = TRUE),
    min = ~min(., na.rm = TRUE),
    Q1 = ~quantile(., probs = 0.25, na.rm = TRUE),
    Q3 = ~quantile(., probs = 0.75, na.rm = TRUE),
    max = ~max(., na.rm = TRUE)
  ), .names = "{.col}.{.fn}")) |>
  pivot_longer(cols = everything(),
               names_to = "variable",
               values_to = "value")

```
**Nhận xét**
1. Nhận xét về xu hướng trung tâm

- Mean = 78.08
- Median = 14.2

=> Trung bình lớn hơn nhiều so với trung vị, chứng tỏ dữ liệu lệch phải (skewed right).
Điều này có nghĩa là hầu hết các giếng có hàm lượng Chlorine thấp, nhưng tồn tại một số giếng với hàm lượng rất cao làm tăng giá trị trung bình.

2. Nhận xét về độ biến thiên

- SD = 210.02 => rất lớn so với median 14.2, cho thấy biến thiên cực lớn trong hàm lượng Chlorine.

- Khoảng giá trị: Min = 1, Max = 1550 → sự khác biệt cực lớn giữa các giếng.
```{r}
ggplot(data_enviroment |> filter(!is.na(Chlorine)),
       aes(x = Chlorine)) +
  geom_histogram(bins = 30) +
  labs(title = "Phân bố hàm lượng Chlorine")
```
**Nhận xét**
1. Phân bố lệch phải (Right-skewed):

Hầu hết các giếng có Chlorine thấp (gần median = 14.2).Một số quan sát với hàm lượng rất cao (cận max = 1550) kéo đuôi phải dài → mean > median.

2. Đặc điểm nổi bật:

Histogram sẽ có cột cao ở khoảng giá trị thấp, và các cột thấp hơn trải dài về phía giá trị lớn. Cho thấy tập trung phần lớn dữ liệu ở mức thấp, một số ít giếng với hàm lượng cực đoan.
```{r}
ggplot(data_enviroment |> filter(!is.na(Chlorine)),
       aes(y = Chlorine)) +
  geom_boxplot() +
  labs(title = "Boxplot hàm lượng Chlorine")
```
**Nhận xét**
1. Phát hiện outliers:

- Giá trị cực đại (1550) và một số giá trị lớn khác sẽ xuất hiện ngoài “râu” (outliers).
- Phần “hộp” sẽ tập trung quanh giá trị trung tâm.(Q1 = 5, meadian = 14.2, Q3 = 55.5)

2. Phân bố dữ liệu:

Hộp nằm sát phần dưới của thang giá trị, phần râu dài về phía giá trị cao => xác nhận dữ liệu lệch phải.

### (b) 
Tạo mẫu bootstrap cho trung bình hàm lượng chlorine trong nước giếng.

Giả thuyết thống kê 

- $H_0$: μ = 0 (trung bình hàm lượng Chlorine bằng 0)

- $H_1$: μ khác 0 (trung bình Chlorine lớn hơn 0 hoặc nhỏ hơn 0)
```{r}
boot_test_mean <- function(
  x,
  mu = 0,
  R = 5000,
  alternative = c("two.sided", "greater", "less"),
  seed = NULL
) {
  alternative <- match.arg(alternative)
  if (!is.null(seed)) set.seed(seed)
  
  x <- x[!is.na(x)]
  n <- length(x)
  
  obs_mean <- mean(x)
  
  x_tilde <- x - mean(x) + mu
  
  # Bootstrap samples
  boot_means <- replicate(R, mean(sample(x_tilde, size = n, replace = TRUE)))
  
  p_val <- switch(
    alternative,
    "two.sided" = mean(abs(boot_means - mu) >= abs(obs_mean - mu)),
    "greater"   = mean(boot_means > obs_mean),
    "less"      = mean(boot_means < obs_mean)
  )

  
  list(
    obs_mean  = obs_mean,
    boot_means = boot_means,
    p_value   = p_val,
    alternative = alternative
  )
}
```
```{r}
chlorine_data <- data_enviroment |> 
  filter(!is.na(Chlorine)) |> 
  pull(Chlorine)

res_boot <- boot_test_mean(chlorine_data, mu = 0, R = 10000, alternative = "two.sided", seed = 123)

res_boot$obs_mean
res_boot$p_value
```
```{r}
ggplot() +
  geom_histogram(aes(x = res_boot$boot_means), bins = 30, fill = "lightblue", color = "white") +
  geom_vline(xintercept = res_boot$obs_mean, color = "red", linetype = "dashed", linewidth = 1) +
  theme_minimal() +
  labs(title = "Bootstrap Distribution of Mean Chlorine (p-value shaded)",
       x = "Bootstrap sample means",
       y = "Frequency")

```

### c)
Xác định 95% khoảng tin cậy bootstrap quantile cho trung bình hàm lượng chlorine.
```{r}
boot_means <- res_boot$boot_means

ci_95 <- quantile(boot_means, probs = c(0.025, 0.975))
ci_95
```

### d)
Độ chệch bootstrap là bao nhiêu? Tỷ số giữa sai số chuẩn bootstrap của trung bình mẫu và sai số chuẩn theo công thức lý thuyết là bao nhiêu? Diễn giải kết quả này.

```{r}
# Bootstrap bias
bias_boot <- mean(res_boot$boot_means) - res_boot$obs_mean
bias_boot
```
**Nhận xét**
Vì bias âm nên bootstrap dự đoán trung bình nhỏ hơn giá trị quan sát.
```{r}
# Tỉ số giữa SE bootstrap và SE lý thuyết
se_boot <- sd(res_boot$boot_means)

n <- length(chlorine_data)
se_theory <- sd(chlorine_data) / sqrt(n)

ratio_se <- se_boot / se_theory
ratio_se
```
**Nhận xét**
Vì tỷ số $\approx$ 1 nên Bootstrap và công thức lý thuyết cho cùng kết quả. Dữ liệu đủ lớn, bootstrap xác nhận độ tin cậy của SE.


## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
