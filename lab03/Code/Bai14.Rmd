---
title: "Bài 14"
author: "Nguyễn Thái Hưng Thịnh"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)  
```

## Bài tập 14

(Khoa học sức khỏe). Kem chocolate có nhiều calo hơn kem vani không? Bộ dữ liệu
IceCream chứa thông tin về lượng calo của 39 nhãn hiệu kem chocolate và kem vani, tương ứng các biến ChocolateCalories và VanillaCalories.

### a) 
Xem xét bộ dữ liệu, sau đó giải thích tại sao đây là ví dụ về dữ liệu ghép cặp

```{r}
data_ice_cream <- read.csv(file ="../Code/data/IceCream.csv")
str(data_ice_cream)
```
**Nhận xét**
- Chúng ta có $n=39$ quan sát (observation) hay $n=39$ hàng.
- Chúng ta có các biến Brand, VanillaCalories và ChocolateCalories, VanillaFat và ChocolateFat, VanillaSugar và ChocolateSugar  cùng tồn tại trong một data.frame.

```{r}
head(data_ice_cream)
```

**Nhận xét**
Dữ liệu thể hiện rõ cấu trúc cặp trùng khớp (matched pairs):
- Đơn vị quan sát (Observation Unit): Mỗi hàng đại diện cho một Nhãn hiệu (Brand) duy nhất.
- Cặp biến số: Hai biến quan tâm VanillaCalories ($X$) và ChocolateCalories ($Y$) nằm trên cùng một hàng.
- Kết luận sơ bộ: Cấu trúc này gợi ý rằng $X$ và $Y$ không độc lập mà gắn liền với nhau thông qua đặc tính của Nhãn hiệu. Đây là dấu hiệu nhận biết cơ bản của dữ liệu ghép cặp (paired data).

Cho nên ta dùng cov để kiểm tra?

Gọi - $i = 1, \dots, 39$ là chỉ số đại diện cho Nhãn hiệu (Brand) (đơn vị thực nghiệm).
    - $X_i$ là biến ngẫu nhiên đại diện cho lượng calo kem Vani (VanillaCalories) của nhãn hiệu $i$.
    - $Y_i$ là biến ngẫu nhiên đại diện cho lượng calo kem Chocolate (ChocolateCalories) của nhãn hiệu $i$.
    - $D = \text{Chocolate} - \text{Vanilla}$ và $\mu_D$ là trung bình thực của các chênh lệch này trong quần thể.
    
Ta có : $H_0$ - Null Hypothesis: Trung bình lượng calo của kem chocolate và kem vani là như nhau ($H_0: \mu_D = 0$)
        $H_a$ - Alternative Hypothesis: Trung bình lượng calo của kem chocolate nhiều hơn kem vani $H_a: \mu_D > 0$
    
```{r}
# ---------------------------------------------------------
# PHẦN 1: CHUẨN BỊ DỮ LIỆU
# ---------------------------------------------------------
X <- data_ice_cream$VanillaCalories      
Y <- data_ice_cream$ChocolateCalories    
D <- Y - X                               

# ---------------------------------------------------------
# PHẦN 2: KIỂM CHỨNG HIỆP PHƯƠNG SAI (COVARIANCE)
# Lý thuyết: Nếu ghép cặp đúng, Cov(X,Y) > 0.
# ---------------------------------------------------------

# Tính hệ số tương quan Pearson (r)
cor_xy <- cor(X, Y)
# Kỳ vọng: r rất gần 1 (vì cùng một hãng sản xuất)

# Tính Hiệp phương sai (Covariance)
cov_xy <- cov(X, Y)

# In kết quả 
cat("\n--- r VÀ cov ---\n")
cat("Hệ số tương quan Pearson (r):", cor_xy, "\n")
cat("Hiệp phương sai giữa X và Y (Cov):", cov_xy, "\n")

# ---------------------------------------------------------
# PHẦN 3: CHỨNG MINH SỰ GIẢM PHƯƠNG SAI (VARIANCE REDUCTION)
# Lý thuyết: Var(D) = Var(X) + Var(Y) - 2*Cov(X,Y)
# ---------------------------------------------------------

var_x <- var(X)
var_y <- var(Y)
var_d_thuc_te <- var(D)

# Tính tổng phương sai (nếu giả sử độc lập)
var_independent <- var_x + var_y

# Tính thành phần giảm trừ (Reduction term)
reduction_term <- 2 * cov_xy

# In kết quả so sánh
cat("\n--- SO SÁNH PHƯƠNG SAI ---\n")
cat("Phương sai của Vani Var(X):", var_x, "\n")
cat("Phương sai của Chocolate Var(Y):", var_y, "\n")
cat("Tổng phương sai (nếu độc lập):", var_independent, "\n")
cat("Thành phần giảm trừ (2*Cov):", reduction_term, "\n")
cat("Phương sai của khác biệt Var(D) [Thực tế]:", var_d_thuc_te, "\n")

# Kiểm chứng công thức toán học
cat("Kiểm chứng công thức (Var_Indep - 2Cov):", var_independent - reduction_term, "\n")

# ---------------------------------------------------------
# PHẦN 4: HỆ QUẢ LÊN KIỂM ĐỊNH T (T-TEST IMPLICATION)
# So sánh p-value khi dùng sai (độc lập) và dùng đúng (ghép cặp)
# ---------------------------------------------------------

test_wrong <- t.test(Y, X, paired = FALSE) 
test_right <- t.test(Y, X, paired = TRUE)  

cat("\n--- SO SÁNH KẾT QUẢ KIỂM ĐỊNH ---\n")
cat("P-value (Giả định độc lập):", test_wrong$p.value, "\n")
cat("P-value (Giả định ghép cặp):", test_right$p.value, "\n")
```
**Nhận xét**
- Hệ số tương quan: r $\approx$ 0.98 cho thấy mối quan hệ tuyến tính cực mạnh. Nếu biết lượng calo Vani, ta có thể dự đoán lượng calo Chocolate với độ chính xác rất cao. Điều này xác nhận giả định $\text{Cov}(X, Y) > 0$.

- Phân tích phương sai:
$$\text{Var}(D) = \underbrace{\text{Var}(X) + \text{Var}(Y)}_{\text{Tổng phương sai nhiễu}} - \underbrace{2\text{Cov}(X, Y)}_{\text{Thành phần khử nhiễu}}$$
  + Tổng phương sai nhiễu (Nếu độc lập): $\approx$ 7416.1. Con số này rất lớn, đại diện cho sự chênh lệch khổng lồ giữa các nhãn hiệu kem khác nhau trên thị trường.

  + Thành phần khử nhiễu: $\approx 7248.9$. Nhờ ghép cặp, chúng ta đã "loại bỏ" được lượng phương sai này.
  
  + Phương sai thực tế của hiệu số: $\approx 167.2$.
  
- Phần so sánh P-value:
  + Trường hợp giả định độc lập :$p\text{-value} \approx 0.596$ ($> 0.05$).
  + Diễn giải: Nếu ta sai lầm coi hai mẫu là độc lập, sai số chuẩn (Standard Error) sẽ bị thổi phồng bởi phương sai lớn ($7416$). Kết quả là ta không thể bác bỏ $H_0$. Ta sẽ kết luận sai lầm rằng "không có sự khác biệt giữa hai vị kem". 
  
  + Trường hợp giả định ghép cặp :$p\text{-value} \approx 0.001$ ($< 0.05$).
  + Diễn giải: Khi xử lý đúng, sai số chuẩn giảm mạnh (do phương sai chỉ còn $167$). Tín hiệu khác biệt ($d \approx 7.3$ calo) trở nên rõ ràng trên nền nhiễu thấp. Ta bác bỏ $H_0$ một cách tự tin.
  
**Kết luận**
Đây là một ví dụ kinh điển về dữ liệu ghép cặp.

- Về mặt thiết kế: Các cặp quan sát $(x_i, y_i)$ được liên kết bởi một biến phân loại chung là Nhãn hiệu (Brand).

-Về mặt thống kê: Sự phụ thuộc này tạo ra một hiệp phương sai dương rất lớn ($\text{Cov} \approx 3624$), giúp triệt tiêu nhiễu biến thiên giữa các nhãn hiệu và làm lộ rõ sự khác biệt thực sự giữa hai hương vị.

### b) 
Tính toán thống kê tổng hợp về lượng calo của hai hương vị.

```{r}
calories_data <- data_ice_cream[, c("VanillaCalories", "ChocolateCalories")]
summary(calories_data)
```
```{r}
V <- data_ice_cream$VanillaCalories
C <- data_ice_cream$ChocolateCalories

# Tính toán các chỉ số thống kê
n_obs <- length(V)
sd_v <- sd(V)
sd_c <- sd(C)

# Tính Sai số chuẩn của Trung bình (SEM)
sem_v <- sd_v / sqrt(n_obs)
sem_c <- sd_c / sqrt(n_obs)

# Tính các phân vị (Q1, Median, Q3)
q_v <- quantile(V, probs = c(0.25, 0.50, 0.75))
q_c <- quantile(C, probs = c(0.25, 0.50, 0.75))

stats_table <- data.frame(
  Variable = c("VanillaCalories", "ChocolateCalories"),
  N = n_obs,
  Mean = c(mean(V), mean(C)),
  SD = c(sd_v, sd_c),
  SEM = c(sem_v, sem_c),
  Median = c(q_v[2], q_c[2]),
  Q1 = c(q_v[1], q_c[1]),
  Q3 = c(q_v[3], q_c[3]),
  Min = c(min(V), min(C)),
  Max = c(max(V), max(C))
)
stats_table
```

### c)
Thực hiện phép thử hoán vị để xác định xem kem chocolate có trung bình calo nhiều hơn kem
vani hay không.

Gọi:
    - $X_i$ là biến ngẫu nhiên đại diện cho lượng calo kem Vani (VanillaCalories) của nhãn hiệu $i$.
    - $Y_i$ là biến ngẫu nhiên đại diện cho lượng calo kem Chocolate (ChocolateCalories) của nhãn hiệu $i$.
    - $D = \text{Chocolate} - \text{Vanilla}$ và $\mu_D$ là trung bình thực của các chênh lệch này trong quần thể.
    
Ta có : $H_0$ - Null Hypothesis: Trung bình lượng calo của kem chocolate và kem vani là như nhau ($H_0: \mu_D = 0$)
        $H_a$ - Alternative Hypothesis: Trung bình lượng calo của kem chocolate nhiều hơn kem vani $H_a: \mu_D > 0$
        Thống kê quan sát ($\bar{d}_{obs}$): Trung bình chênh lệch calo quan sát được :$\bar{d}_{obs} = \bar{Y} - \bar{X}$

```{r}
# C1: Code tay theo cong thuc 
observed_mean_diff <- mean(D)
N_permutations <- 10000
set.seed(42) 

permutation_means <- replicate(N_permutations, {
  random_signs <- sample(c(-1, 1), size = n_obs, replace = TRUE)
  permuted_diffs <- D * random_signs
  mean(permuted_diffs)
})

p_value <- sum(permutation_means >= observed_mean_diff) / N_permutations

round(observed_mean_diff, 4)
p_value
```

```{r}
# C2: Theo hàm permutation 
perm_test_paired_sign_flip <- function(D, R = 10000, alternative = c("two.sided", "greater", "less")) {
  
  observed_mean_diff <- mean(D)
  n <- length(D)
  alternative <- match.arg(alternative)
  
  mean_diff_perm <- replicate(R, {
    random_signs <- sample(c(-1, 1), size = n, replace = TRUE)
    permuted_diffs <- D * random_signs
    mean(permuted_diffs)
  })
  
  p_val <- switch(alternative,
    "two.sided" = mean(abs(mean_diff_perm) >= abs(observed_mean_diff)),
    "greater"   = mean(mean_diff_perm > observed_mean_diff), 
    "less"      = mean(mean_diff_perm < observed_mean_diff)
  )
  
  return(list(
    observed_mean_diff = observed_mean_diff,
    p_val = p_val,
    alternative = alternative
  ))
}

ket_qua_kiem_dinh <- perm_test_paired_sign_flip(D, alternative = "greater", R = 10000)
round(ket_qua_kiem_dinh$observed_mean_diff, 4)
ket_qua_kiem_dinh$p_val

```
**Nhận xét**
- Thống kê quan sát ($\bar{d}_{obs}$): Trung bình chênh lệch calo quan sát được :$\bar{d}_{obs} = \bar{Y} - \bar{X} \approx 7.3333 \Rightarrow $ Mức chênh lệch trung bình được đo lường thực tế thì calo Chocolate > calo Vani.

- $p\text{-value} \approx 1e-04 < \alpha = 0.05 \Rightarrow Bác bỏ giả thuyết H_0.$.
Vậy kem chocolate có trung bình calo nhiều hơn kem vani.

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.